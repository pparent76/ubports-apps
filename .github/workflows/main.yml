name: Build and Publish Whatsweb
on:
  # DISPARADORES AUTOM√ÅTICOS
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  # DISPARADOR MANUAL
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Build Click Package
        run: |
          docker run \
            -v $(pwd)/whatsweb:/app \
            clickable/clickable:latest \
            --project-dir=/app
      - name: Upload .click Artifact
        uses: actions/upload-artifact@v3
        with:
          name: whatsweb-click-package
          path: whatsweb/build/**/*.click
  publish:
    needs: build
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download .click Artifact
        uses: actions/download-artifact@v3
        with:
          name: whatsweb-click-package
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install openstore-cli
        run: pip install openstore-cli
      - name: Upload to OpenStore
        env:
          OPENSTORE_API_KEY: ${{ secrets.OPENSTORE_TOKEN }}
        run: |
          CLICK_FILE=$(find . -name "*.click")
          echo "Uploading $CLICK_FILE to the OpenStore..."
          openstore-cli upload $CLICK_FILE --yes
